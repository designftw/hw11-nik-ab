<!DOCTYPE html>
<html>
  <head>
    <script type="module" src="./chat.js"></script> 
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <h1>My Cool Chat App</h1>

      <!-- Begin problem 3 solution -->
      <h2>Welcome {{myUsername}}</h2>
      <!-- End problem 3 solution -->

      <div>
        <button @click="$gf.toggleLogIn">
          <!-- If we have a user ID, we're logged in so show "Log Out" -->
          <!-- Otherwise, show "Log In" -->
          {{ $gf.me? 'Log Out' : 'Log In' }}
        </button>
      </div>

      <!-- If we're not logged in, hide everything except the login button -->
      <template v-if="$gf.me">
        <!-- Begin Problem 1 Solution -->
        <div>
          <form @submit.prevent="setUsername">
            <input
              v-model="preferredUsername"
              placeholder="Choose a username..."
            />
            <input type="submit" value="Set Username" />
          </form>
          {{ usernameResult }}
        </div>
        <!-- End Problem 1 Solution -->

        <div>
          <!-- We display names in multiple places, so we made a -->
          <!-- reusable <name></name> component. -->
          <!-- See below for the template. -->
          My Name Is: <name :actor="$gf.me" :editable="true"></name>
          
         </div>
         <div>
          My Picture Is: <profile-picture :actor="$gf.me" :editable="true"></profile-picture>
      
         </div>
        <div>
          Change chat format:
          <input
            type="radio"
            id="channel"
            :value="false"
            v-model="privateMessaging"
          />
          <label for="channel">Channel-based public chat</label>

          <input
            type="radio"
            id="pm"
            :value="true"
            v-model="privateMessaging"
          />
          <label for="pm">Private Messaging</label>
        </div>

        <div v-if="!privateMessaging">
          <label for="channel"> Change the channel you're chatting in: </label>
          <input id="channel" v-model="channel" />
        </div>
        <!-- Begin problem 2 solution -->
        <div v-else>
          <form @submit.prevent="chatWithUser">
            <label for="recipient">
              Type the user ID of who you'd like to chat with:
            </label>
            <input id="recipient" v-model="recipientUsernameSearch" />
            <input type="submit" value="Search" />
          </form>
          <span v-if="recipient"> Chatting with {{ recipientUsername }} </span>
          <span v-else> Username {{ recipientUsername }} does not exist! </span>
        </div>
        <!-- End problem 2 solution -->

        <!-- A form for sending messages -->
        <form @submit.prevent="sendMessage">
          <input v-model="messageText" placeholder="Type a message..." />
          <input type="file" accept="image/*" @change="onImageAttachment" />
          <input type="submit" value="Send" />
        </form>

        <ul>
          <!-- List all the messages -->
          <li v-for="message of messages" :key="message.id">
            <!-- Display and edit form if we're editing a message -->
            <form
              v-if="editID==message.id"
              @submit.prevent="saveEditMessage(message)"
            >
              <input v-model="editText" />
              <input type="submit" value="Save" />
            </form>

            <!-- Otherwise, display a bunch of properties from the message -->
            <ul v-else>
              <li>Message: {{ message.content }}</li>
              <li>Picture: <profile-picture :actor = "message.actor"></profile-picture></li>
              <li>From Name: <name :actor="message.actor"></name></li>
              <li>From Actor ID: {{ message.actor }}</li>
              <li>From Username: {{ actorsToUsernames[message.actor] }}</li>
              <template v-if="privateMessaging">
                <li>To Name: <name :actor="message.bto[0]"></name></li>
                <li>To Actor ID: {{ message.bto[0] }}</li>
                <li>To Username: {{ actorsToUsernames[message.bto[0]] }}</li>
              </template>
              <li>Published at Time: {{ message.published }}</li>
              <li>Last Edited at Time: {{ message.updated }}</li>
              <li>
                <!-- This is a unique identifier that can be used to "link" to messages -->
                ID: {{ message.id }}
              </li>

              <li
                v-if="message.attachment && message.attachment.magnet in imageDownloads"
              >
                <span
                  v-if="imageDownloads[message.attachment.magnet]=='downloading'"
                >
                  Image is downloading...
                </span>
                <span
                  v-else-if="imageDownloads[message.attachment.magnet]=='error'"
                >
                  Image could not be downloaded!
                </span>
                <img v-else :src="imageDownloads[message.attachment.magnet]" />
              </li>

              <!-- Only add these controls if the message is ours -->
              <!-- You can't edit or delete other people's messages -->
              <template v-if="message.actor==$gf.me">
                <li>
                  <button @click="removeMessage(message)">
                    Delete Message
                  </button>
                </li>
                <li>
                  <button @click="startEditMessage(message)">
                    Edit Message
                  </button>
                </li>
              </template>

              <li>
                <like :messageid="message.id"></like>
              </li>
              <li>
                <read-receipts
                  :actors-to-usernames="actorsToUsernames"
                  :messageid="message.id"
                ></read-receipts>
              </li>
              <li>
                <replies :messageid="message.id"></replies>
              </li>
            </ul>
          </li>
        </ul>
      </template>
    </div>

    <template id="name">
      <span v-if="!editing">
        <!-- If we're not editing the name-->
        <!-- Display the profile's name, if it exists -->
        <!-- or anonymous if it doesn't -->
        {{ profile? profile.name : 'Anonymous' }}

        <!-- Also if the name is "editable" add an edit button -->
        <button v-if="editable" @click="editName">Edit Name</button>
      </span>

      <!-- If we're in the editing state, create something to edit the name-->
      <form v-else @submit.prevent="saveName">
        <input v-model="editText" />
        <input type="submit" value="Save Name" />
      </form>
    </template>

    <template id="like">
      <button @click="toggleLike">
        {{ myLikes.length? 'Unlike' : 'Like' }}
      </button>
      # of likes: {{ numLikes }}
    </template>

    <template id="read_receipts">
      <ul>
        <li v-for="actor of readActors">
          <name :actor="actor" :editable="false"></name>
        </li>
      </ul>
    </template>
    <template id="replies">
      <form @submit.prevent="sendReply">
        <input v-model="replyText" placeholder="Type a reply..." />
        <input type="submit" value="Send" />
      </form>
      <ul>
        <li v-for="reply in replies">{{reply.content}}</li>
      </ul>
    </template>

    <template id="profile_picture">
      <span v-if="!editing">
        <!-- If we're not editing the name-->
        <!-- Display the profile's name, if it exists -->
        <!-- or anonymous if it doesn't -->
        <img v-if = "imageUrl.length > 0" :src = "imageUrl" class ="profile_picture">
        <div v-else> no image</div>

        <!-- Also if the name is "editable" add an edit button -->
        <button v-if="editable" @click="editImage">Change Picture</button>
      </span>
      <!-- If we're in the editing state, create something to edit the name-->
      <form v-else @submit.prevent="saveImage">
        <input type="file" accept="image/*" @change="changeImage" />
        <input type="submit" value="Save Name" />
      </form>
    </template>
  </body>
</html>
